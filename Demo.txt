-- Script tối ưu cho Dungeon Quest với Krnl, thêm Discord Webhook
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")
local workspace = game.Workspace
local replicatedStorage = game:GetService("ReplicatedStorage")
local userInputService = game:GetService("UserInputService")
local virtualInputManager = game:GetService("VirtualInputManager")
local runService = game:GetService("RunService")
local httpService = game:GetService("HttpService")

-- Tạo UI
local gui = Instance.new("ScreenGui")
gui.Name = "KinayoScriptUI"
gui.Parent = player:WaitForChild("PlayerGui")
gui.ResetOnSpawn = false

-- Tạo khung chính (ban đầu ẩn)
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 250, 0, 350) -- Tăng chiều cao để thêm phần webhook
frame.Position = UDim2.new(0.5, -125, 0.5, -175)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Parent = gui
frame.Visible = false

-- Logo nhỏ (nút bật/tắt)
local logoButton = Instance.new("TextButton")
logoButton.Size = UDim2.new(0, 40, 0, 40)
logoButton.Position = UDim2.new(0, 10, 0, 10)
logoButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
logoButton.Text = "K"
logoButton.TextColor3 = Color3.fromRGB(255, 255, 255)
logoButton.TextScaled = true
logoButton.BorderSizePixel = 0
logoButton.BackgroundTransparency = 0.2
logoButton.Parent = gui

-- Làm tròn logo
local logoCorner = Instance.new("UICorner")
logoCorner.CornerRadius = UDim.new(1, 0)
logoCorner.Parent = logoButton

-- Tiêu đề
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
title.Text = "KINAYO Script - Dungeon Quest"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextScaled = true
title.TextSize = 14
title.Parent = frame

-- Nút Reset (reset nhân vật)
local resetButton = Instance.new("TextButton")
resetButton.Size = UDim2.new(0, 50, 0, 25)
resetButton.Position = UDim2.new(1, -55, 0, 0)
resetButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
resetButton.Text = "RESET"
resetButton.TextColor3 = Color3.fromRGB(255, 255, 255)
resetButton.TextScaled = true
resetButton.TextSize = 14
resetButton.Parent = frame

-- Thanh trượt Auto Dungeon
local autoDungeonLabel = Instance.new("TextLabel")
autoDungeonLabel.Size = UDim2.new(0, 80, 0, 20)
autoDungeonLabel.Position = UDim2.new(0, 10, 0, 35)
autoDungeonLabel.BackgroundTransparency = 1
autoDungeonLabel.Text = "Auto Dungeon"
autoDungeonLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
autoDungeonLabel.TextScaled = true
autoDungeonLabel.TextSize = 14
autoDungeonLabel.Parent = frame

local autoDungeonSlider = Instance.new("TextButton")
autoDungeonSlider.Size = UDim2.new(0, 130, 0, 15)
autoDungeonSlider.Position = UDim2.new(0, 100, 0, 38)
autoDungeonSlider.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
autoDungeonSlider.Text = "OFF"
autoDungeonSlider.TextColor3 = Color3.fromRGB(255, 255, 255)
autoDungeonSlider.TextScaled = true
autoDungeonSlider.TextSize = 12
autoDungeonSlider.Parent = frame

-- Nút Autofarm
local autofarmButton = Instance.new("TextButton")
autofarmButton.Size = UDim2.new(0, 110, 0, 25)
autofarmButton.Position = UDim2.new(0, 10, 0, 65)
autofarmButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
autofarmButton.Text = "Autofarm: OFF"
autofarmButton.TextColor3 = Color3.fromRGB(255, 255, 255)
autofarmButton.TextScaled = true
autofarmButton.TextSize = 14
autofarmButton.Parent = frame

-- Nút Autoclick Weapon
local autoclickWeaponButton = Instance.new("TextButton")
autoclickWeaponButton.Size = UDim2.new(0, 110, 0, 25)
autoclickWeaponButton.Position = UDim2.new(0, 130, 0, 65)
autoclickWeaponButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
autoclickWeaponButton.Text = "Autoclick Weapon: OFF"
autoclickWeaponButton.TextScaled = true
autoclickWeaponButton.TextColor3 = Color3.fromRGB(255, 255, 255)
autoclickWeaponButton.TextSize = 14
autoclickWeaponButton.Parent = frame

-- Nút Wavefarm
local wavefarmButton = Instance.new("TextButton")
wavefarmButton.Size = UDim2.new(0, 110, 0, 25)
wavefarmButton.Position = UDim2.new(0, 10, 0, 95)
wavefarmButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
wavefarmButton.Text = "Wavefarm: OFF"
wavefarmButton.TextScaled = true
wavefarmButton.TextColor3 = Color3.fromRGB(255, 255, 255)
wavefarmButton.TextSize = 14
wavefarmButton.Parent = frame

-- Nút Autostats (dạng lựa chọn)
local autostatsButton = Instance.new("TextButton")
autostatsButton.Size = UDim2.new(0, 110, 0, 25)
autostatsButton.Position = UDim2.new(0, 130, 0, 95)
autostatsButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
autostatsButton.Text = "Autostats: None"
autostatsButton.TextScaled = true
autostatsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
autostatsButton.TextSize = 14
autostatsButton.Parent = frame

-- Khung lựa chọn cho Autostats (ban đầu ẩn)
local autostatsFrame = Instance.new("Frame")
autostatsFrame.Size = UDim2.new(0, 110, 0, 75)
autostatsFrame.Position = UDim2.new(0, 130, 0, 120)
autostatsFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
autostatsFrame.BorderSizePixel = 0
autostatsFrame.Visible = false
autostatsFrame.Parent = frame

local physicalOption = Instance.new("TextButton")
physicalOption.Size = UDim2.new(1, 0, 0, 25)
physicalOption.Position = UDim2.new(0, 0, 0, 0)
physicalOption.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
physicalOption.Text = "Physical"
physicalOption.TextColor3 = Color3.fromRGB(255, 255, 255)
physicalOption.TextScaled = true
physicalOption.TextSize = 14
physicalOption.Parent = autostatsFrame

local spellOption = Instance.new("TextButton")
spellOption.Size = UDim2.new(1, 0, 0, 25)
spellOption.Position = UDim2.new(0, 0, 0, 25)
spellOption.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
spellOption.Text = "Spell"
spellOption.TextColor3 = Color3.fromRGB(255, 255, 255)
spellOption.TextScaled = true
spellOption.TextSize = 14
spellOption.Parent = autostatsFrame

local staminaOption = Instance.new("TextButton")
staminaOption.Size = UDim2.new(1, 0, 0, 25)
staminaOption.Position = UDim2.new(0, 0, 0, 50)
staminaOption.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
staminaOption.Text = "Stamina"
staminaOption.TextColor3 = Color3.fromRGB(255, 255, 255)
staminaOption.TextScaled = true
staminaOption.TextSize = 14
staminaOption.Parent = autostatsFrame

-- Nút Disable Render
local disableRenderButton = Instance.new("TextButton")
disableRenderButton.Size = UDim2.new(0, 110, 0, 25)
disableRenderButton.Position = UDim2.new(0, 10, 0, 125)
disableRenderButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
disableRenderButton.Text = "Disable Render: OFF"
disableRenderButton.TextScaled = true
disableRenderButton.TextColor3 = Color3.fromRGB(255, 255, 255)
disableRenderButton.TextSize = 14
disableRenderButton.Parent = frame

-- Nút Use Skill
local useSkillButton = Instance.new("TextButton")
useSkillButton.Size = UDim2.new(0, 110, 0, 25)
useSkillButton.Position = UDim2.new(0, 130, 0, 125)
useSkillButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
useSkillButton.Text = "Use Skill: OFF"
useSkillButton.TextScaled = true
useSkillButton.TextColor3 = Color3.fromRGB(255, 255, 255)
useSkillButton.TextSize = 14
useSkillButton.Parent = frame

-- Nút Auto Dungeon (nút)
local autoDungeonButton = Instance.new("TextButton")
autoDungeonButton.Size = UDim2.new(0, 110, 0, 25)
autoDungeonButton.Position = UDim2.new(0, 10, 0, 155)
autoDungeonButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
autoDungeonButton.Text = "Auto Dungeon: OFF"
autoDungeonButton.TextScaled = true
autoDungeonButton.TextColor3 = Color3.fromRGB(255, 255, 255)
autoDungeonButton.TextSize = 14
autoDungeonButton.Parent = frame

-- Nút Gregg Farm
local greggFarmButton = Instance.new("TextButton")
greggFarmButton.Size = UDim2.new(0, 110, 0, 25)
greggFarmButton.Position = UDim2.new(0, 130, 0, 155)
greggFarmButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
greggFarmButton.Text = "Gregg Farm: OFF"
greggFarmButton.TextScaled = true
greggFarmButton.TextColor3 = Color3.fromRGB(255, 255, 255)
greggFarmButton.TextSize = 14
greggFarmButton.Parent = frame

-- Nút Hold Skills
local holdSkillsButton = Instance.new("TextButton")
holdSkillsButton.Size = UDim2.new(0, 110, 0, 25)
holdSkillsButton.Position = UDim2.new(0, 10, 0, 185)
holdSkillsButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
holdSkillsButton.Text = "Hold Skills: OFF"
holdSkillsButton.TextScaled = true
holdSkillsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
holdSkillsButton.TextSize = 14
holdSkillsButton.Parent = frame

-- Nút Bonus Boss
local bonusBossButton = Instance.new("TextButton")
bonusBossButton.Size = UDim2.new(0, 110, 0, 25)
bonusBossButton.Position = UDim2.new(0, 130, 0, 185)
bonusBossButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
bonusBossButton.Text = "Bonus Boss: OFF"
bonusBossButton.TextScaled = true
bonusBossButton.TextColor3 = Color3.fromRGB(255, 255, 255)
bonusBossButton.TextSize = 14
bonusBossButton.Parent = frame

-- Discord Webhook Input
local webhookLabel = Instance.new("TextLabel")
webhookLabel.Size = UDim2.new(0, 80, 0, 20)
webhookLabel.Position = UDim2.new(0, 10, 0, 215)
webhookLabel.BackgroundTransparency = 1
webhookLabel.Text = "Webhook URL"
webhookLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
webhookLabel.TextScaled = true
webhookLabel.TextSize = 14
webhookLabel.Parent = frame

local webhookInput = Instance.new("TextBox")
webhookInput.Size = UDim2.new(0, 200, 0, 25)
webhookInput.Position = UDim2.new(0, 10, 0, 235)
webhookInput.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
webhookInput.Text = "Enter Discord Webhook URL"
webhookInput.TextColor3 = Color3.fromRGB(255, 255, 255)
webhookInput.TextScaled = true
webhookInput.TextSize = 14
webhookInput.Parent = frame

-- Nút Save Webhook
local saveWebhookButton = Instance.new("TextButton")
saveWebhookButton.Size = UDim2.new(0, 110, 0, 25)
saveWebhookButton.Position = UDim2.new(0, 10, 0, 265)
saveWebhookButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
saveWebhookButton.Text = "Save Webhook"
saveWebhookButton.TextScaled = true
saveWebhookButton.TextColor3 = Color3.fromRGB(255, 255, 255)
saveWebhookButton.TextSize = 14
saveWebhookButton.Parent = frame

-- Biến trạng thái
local isAutoDungeonSliderOn = false
local isAutofarmOn = false
local isAutoclickWeaponOn = false
local isWavefarmOn = false
local autostatsMode = "None"
local isDisableRenderOn = false
local isUseSkillOn = false
local isAutoDungeonButtonOn = false
local isGreggFarmOn = false
local isHoldSkillsOn = false
local isBonusBossOn = false
local webhookUrl = ""

-- Hàm kéo thả
local function makeDraggable(element)
    local dragging = false
    local dragStart = nil
    local startPos = nil

    element.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = element.Position
        end
    end)

    element.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    userInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            element.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

makeDraggable(frame)
makeDraggable(logoButton)

-- Logic bật/tắt UI khi bấm logo
local isUIVisible = false
logoButton.MouseButton1Click:Connect(function()
    isUIVisible = not isUIVisible
    frame.Visible = isUIVisible
    if isUIVisible then
        print("UI đã được hiển thị!")
    else
        print("UI đã được ẩn!")
    end
end)

-- Lưu Webhook URL
saveWebhookButton.MouseButton1Click:Connect(function()
    webhookUrl = webhookInput.Text
    print("Webhook URL đã được lưu: " .. webhookUrl)
end)

-- Hàm gửi thông báo qua Discord Webhook
local function sendDiscordNotification()
    if webhookUrl == "" or webhookUrl == "Enter Discord Webhook URL" then
        print("Vui lòng nhập Discord Webhook URL!")
        return
    end

    -- Lấy thông tin người chơi
    local playerName = player.Name
    local gold = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Gold") and player.leaderstats.Gold.Value or 0
    local level = player:FindFirstChild("Level") and player.Level.Value or 0
    local xp = player:FindFirstChild("XP") and player.XP.Value or 0

    -- Định dạng thông báo
    local message = {
        ["content"] = "",
        ["embeds"] = {{
            ["title"] = "Dungeon Quest - Match Completed",
            ["color"] = 3447003,
            ["fields"] = {
                {
                    ["name"] = "Player Info",
                    ["value"] = playerName,
                    ["inline"] = true
                },
                {
                    ["name"] = "Gold",
                    ["value"] = tostring(gold),
                    ["inline"] = true
                },
                {
                    ["name"] = "Level",
                    ["value"] = tostring(level),
                    ["inline"] = true
                },
                {
                    ["name"] = "XP",
                    ["value"] = tostring(xp),
                    ["inline"] = true
                }
            },
            ["footer"] = {
                ["text"] = "Kinayo Script • " .. os.date("%Y-%m-%d %H:%M:%S")
            }
        }}
    }

    -- Gửi thông báo
    local success, err = pcall(function()
        httpService:PostAsync(webhookUrl, httpService:JSONEncode(message), Enum.HttpContentType.ApplicationJson)
    end)

    if success then
        print("Đã gửi thông báo đến Discord!")
    else
        print("Lỗi khi gửi thông báo đến Discord: " .. err)
    end
end

-- Phát hiện khi trận đấu hoàn thành
local function detectMatchEnd()
    while true do
        -- Kiểm tra GUI phần thưởng
        local rewardGui = player.PlayerGui:FindFirstChild("RewardGui") -- Tên GUI có thể khác, cần kiểm tra trong game
        if rewardGui and rewardGui.Visible then
            print("Trận đấu đã hoàn thành! Gửi thông báo đến Discord...")
            sendDiscordNotification()
            wait(5) -- Chờ 5 giây để tránh gửi nhiều thông báo
        end
        wait(1)
    end
end

spawn(detectMatchEnd)

-- 1. Auto Dungeon (Thanh trượt)
local function autoDungeonLogic()
    if not isAutoDungeonSliderOn then return end
    local playerLevel = player:FindFirstChild("Level") and player.Level.Value or 215
    local dungeonName = "Abyssal Void"
    if playerLevel < 215 then
        dungeonName = "Desert Temple"
    end

    local dungeonEvent = replicatedStorage:FindFirstChild("DungeonJoin")
    if dungeonEvent then
        dungeonEvent:FireServer(dungeonName, "Nightmare")
        print("Đã tự động vào " .. dungeonName .. " (Nightmare)!")
    else
        print("Không tìm thấy RemoteEvent để vào hầm ngục!")
    end
end

autoDungeonSlider.MouseButton1Click:Connect(function()
    isAutoDungeonSliderOn = not isAutoDungeonSliderOn
    autoDungeonSlider.Text = isAutoDungeonSliderOn and "ON" or "OFF"
    autoDungeonSlider.BackgroundColor3 = isAutoDungeonSliderOn and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(0, 120, 255)
    if isAutoDungeonSliderOn then
        autoDungeonLogic()
    end
end)

-- 2. Autostats (Lựa chọn)
autostatsButton.MouseButton1Click:Connect(function()
    autostatsFrame.Visible = not autostatsFrame.Visible
end)

physicalOption.MouseButton1Click:Connect(function()
    autostatsMode = "Physical"
    autostatsButton.Text = "Autostats: Physical"
    autostatsFrame.Visible = false
    print("Đã chọn Autostats: Physical")
end)

spellOption.MouseButton1Click:Connect(function()
    autostatsMode = "Spell"
    autostatsButton.Text = "Autostats: Spell"
    autostatsFrame.Visible = false
    print("Đã chọn Autostats: Spell")
end)

staminaOption.MouseButton1Click:Connect(function()
    autostatsMode = "Stamina"
    autostatsButton.Text = "Autostats: Stamina"
    autostatsFrame.Visible = false
    print("Đã chọn Autostats: Stamina")
end)

-- 3. Disable Render
disableRenderButton.MouseButton1Click:Connect(function()
    isDisableRenderOn = not isDisableRenderOn
    disableRenderButton.Text = "Disable Render: " .. (isDisableRenderOn and "ON" or "OFF")
    if isDisableRenderOn then
        game.Lighting.Brightness = 0
        game.Lighting.Ambient = Color3.fromRGB(0, 0, 0)
        print("Đã tắt render để giảm lag!")
    else
        game.Lighting.Brightness = 1
        game.Lighting.Ambient = Color3.fromRGB(127, 127, 127)
        print("Đã bật lại render!")
    end
end)

-- 4. Use Skill (Spam tất cả skill, bypass cooldown với Krnl)
local function bypassCooldown()
    local mt = getrawmetatable(game)
    local oldIndex = mt.__index
    setreadonly(mt, false)

    mt.__index = function(self, key)
        if key == "wait" then
            return function(...)
                return 0
            end
        end
        return oldIndex(self, key)
    end

    setreadonly(mt, true)

    local success, err = pcall(function()
        for _, v in pairs(getgc(true)) do
            if type(v) == "table" then
                for key, value in pairs(v) do
                    if (key:lower():find("cooldown") or key:lower():find("skill")) and value == 3 then
                        rawset(v, key, 0)
                        print("Đã đặt " .. key .. " về 0!")
                    end
                end
            end
        end
    end)

    if success then
        print("Đã bypass cooldown cho tất cả skill có cooldown 3 giây!")
    else
        print("Lỗi khi bypass cooldown: " .. err)
    end

    local successHook, errHook = pcall(function()
        for _, func in pairs(getgc()) do
            if type(func) == "function" and islclosure(func) then
                local constants = getconstants(func)
                for _, const in pairs(constants) do
                    if const == "Cooldown" or const == "cooldown" or const == 3 then
                        hookfunction(func, function(...)
                            return true
                        end)
                        print("Đã hook hàm kiểm tra cooldown!")
                        break
                    end
                end
            end
        end
    end)

    if not successHook then
        print("Lỗi khi hook hàm cooldown: " .. errHook)
    end
end

local function useSkill()
    bypassCooldown()
    while isUseSkillOn do
        local skillKeys = {"Q", "E", "One", "Two", "Three", "Four"}
        for _, key in pairs(skillKeys) do
            virtualInputManager:SendKeyEvent(true, key, false, game)
        end
        runService.Heartbeat:Wait()
        for _, key in pairs(skillKeys) do
            virtualInputManager:SendKeyEvent(false, key, false, game)
        end
    end
end

useSkillButton.MouseButton1Click:Connect(function()
    isUseSkillOn = not isUseSkillOn
    useSkillButton.Text = "Use Skill: " .. (isUseSkillOn and "ON" or "OFF")
    if isUseSkillOn then
        spawn(useSkill)
        print("Đang spam tất cả skill với cooldown bypass!")
    end
end)

-- 5. Gregg Farm
local function greggFarmLogic()
    while isGreggFarmOn do
        local gregg = workspace:FindFirstChild("Gregg")
        if gregg and gregg:FindFirstChild("HumanoidRootPart") then
            rootPart.CFrame = gregg.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
            print("Đang đánh Gregg!")
        end
        runService.Heartbeat:Wait()
    end
end

greggFarmButton.MouseButton1Click:Connect(function()
    isGreggFarmOn = not isGreggFarmOn
    greggFarmButton.Text = "Gregg Farm: " .. (isGreggFarmOn and "ON" or "OFF")
    if isGreggFarmOn then
        spawn(greggFarmLogic)
    end
end)

-- 6. Hold Skills
local function holdSkills()
    while isHoldSkillsOn do
        local skillKeys = {"Q", "E", "One", "Two", "Three", "Four"}
        for _, key in pairs(skillKeys) do
            virtualInputManager:SendKeyEvent(true, key, false, game)
        end
        runService.Heartbeat:Wait()
        for _, key in pairs(skillKeys) do
            virtualInputManager:SendKeyEvent(false, key, false, game)
        end
    end
end

holdSkillsButton.MouseButton1Click:Connect(function()
    isHoldSkillsOn = not isHoldSkillsOn
    holdSkillsButton.Text = "Hold Skills: " .. (isHoldSkillsOn and "ON" or "OFF")
    if isHoldSkillsOn then
        spawn(holdSkills)
    end
end)

-- 7. Bonus Boss
local function bonusBossLogic()
    while isBonusBossOn do
        local bonusBossButton = workspace:FindFirstChild("BonusBossButton")
        if bonusBossButton then
            fireclickdetector(bonusBossButton:FindFirstChildOfClass("ClickDetector"))
            print("Đã kích hoạt Bonus Boss!")
        end
        wait(1)
    end
end

bonusBossButton.MouseButton1Click:Connect(function()
    isBonusBossOn = not isBonusBossOn
    bonusBossButton.Text = "Bonus Boss: " .. (isBonusBossOn and "ON" or "OFF")
    if isBonusBossOn then
        spawn(bonusBossLogic)
    end
end)

-- 8. Auto Retry
local function autoRetry()
    while true do
        local retryButton = player.PlayerGui:FindFirstChild("RetryButton")
        if retryButton and retryButton.Visible then
            fireclickdetector(retryButton:FindFirstChildOfClass("ClickDetector"))
            print("Đã tự động retry!")
        end
        wait(1)
    end
end

spawn(autoRetry)

-- 9. Reset (Reset nhân vật)
resetButton.MouseButton1Click:Connect(function()
    humanoid.WalkSpeed = 0
    humanoid.JumpPower = 0
    humanoid:TakeDamage(humanoid.MaxHealth)
    print("Đã reset nhân vật!")
end)

-- 10. Autofarm (Tối ưu hóa)
local function findNearestEnemy()
    local nearestEnemy = nil
    local shortestDistance = math.huge
    for _, enemy in pairs(workspace:GetChildren()) do
        local enemyHumanoid = enemy:FindFirstChild("Humanoid")
        local enemyRoot = enemy:FindFirstChild("HumanoidRootPart")
        if enemyHumanoid and enemyRoot and enemy ~= character and enemyHumanoid.Health > 0 then
            local distance = (rootPart.Position - enemyRoot.Position).Magnitude
            if distance < shortestDistance then
                nearestEnemy = enemyRoot
                shortestDistance = distance
            end
        end
    end
    return nearestEnemy
end

local function isSafePosition(position)
    for _, area in pairs(workspace:GetChildren()) do
        if area.Name == "DangerArea" and area:IsA("BasePart") then
            local distance = (position - area.Position).Magnitude
            if distance < area.Size.Magnitude then
                return false
            end
        end
    end
    return true
end

local function findSafePosition()
    local basePos = rootPart.Position
    for i = 1, 10 do
        local testPos = basePos + Vector3.new(math.random(-20, 20), 0, math.random(-20, 20))
        if isSafePosition(testPos) then
            return testPos
        end
    end
    return basePos
end

local function autofarmLogic()
    while isAutofarmOn do
        local target = findNearestEnemy()
        if target then
            -- Né vùng nguy hiểm
            for _, area in pairs(workspace:GetChildren()) do
                if area.Name == "DangerArea" and area:IsA("BasePart") then
                    local distance = (rootPart.Position - area.Position).Magnitude
                    if distance < area.Size.Magnitude then
                        local safePos = findSafePosition()
                        rootPart.CFrame = CFrame.new(safePos)
                        print("Đã né vùng nguy hiểm!")
                    end
                end
            end

            -- Dịch chuyển lên đầu quái và tấn công
            rootPart.CFrame = target.CFrame * CFrame.new(0, 5, 0)
            if isUseSkillOn then
                                local skillKeys = {"Q", "E", "One", "Two", "Three", "Four"}
                for _, key in pairs(skillKeys) do
                    virtualInputManager:SendKeyEvent(true, key, false, game)
                end
                runService.Heartbeat:Wait()
                for _, key in pairs(skillKeys) do
                    virtualInputManager:SendKeyEvent(false, key, false, game)
                end
            end
            -- Tự động tấn công nếu không dùng skill
            virtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
            runService.Heartbeat:Wait()
            virtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        else
            -- Nếu không tìm thấy quái, chờ một chút
            wait(0.1)
        end
        runService.Heartbeat:Wait()
    end
end

autofarmButton.MouseButton1Click:Connect(function()
    isAutofarmOn = not isAutofarmOn
    autofarmButton.Text = "Autofarm: " .. (isAutofarmOn and "ON" or "OFF")
    if isAutofarmOn then
        spawn(autofarmLogic)
        print("Đã bật Autofarm!")
    else
        print("Đã tắt Autofarm!")
    end
end)

-- 11. Autoclick Weapon
local function autoclickWeaponLogic()
    while isAutoclickWeaponOn do
        virtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        runService.Heartbeat:Wait()
        virtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        runService.Heartbeat:Wait()
    end
end

autoclickWeaponButton.MouseButton1Click:Connect(function()
    isAutoclickWeaponOn = not isAutoclickWeaponOn
    autoclickWeaponButton.Text = "Autoclick Weapon: " .. (isAutoclickWeaponOn and "ON" or "OFF")
    if isAutoclickWeaponOn then
        spawn(autoclickWeaponLogic)
        print("Đã bật Autoclick Weapon!")
    else
        print("Đã tắt Autoclick Weapon!")
    end
end)

-- 12. Wavefarm
local function wavefarmLogic()
    while isWavefarmOn do
        -- Tìm và di chuyển đến vị trí wave
        for _, wave in pairs(workspace:GetChildren()) do
            if wave.Name == "Wave" and wave:IsA("BasePart") then
                rootPart.CFrame = wave.CFrame * CFrame.new(0, 5, 0)
                print("Đang farm tại Wave!")
                break
            end
        end
        -- Tự động tấn công
        virtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        runService.Heartbeat:Wait()
        virtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        runService.Heartbeat:Wait()
    end
end

wavefarmButton.MouseButton1Click:Connect(function()
    isWavefarmOn = not isWavefarmOn
    wavefarmButton.Text = "Wavefarm: " .. (isWavefarmOn and "ON" or "OFF")
    if isWavefarmOn then
        spawn(wavefarmLogic)
        print("Đã bật Wavefarm!")
    else
        print("Đã tắt Wavefarm!")
    end
end)

-- 13. Auto Dungeon (Nút)
local function autoDungeonButtonLogic()
    while isAutoDungeonButtonOn do
        local playerLevel = player:FindFirstChild("Level") and player.Level.Value or 215
        local dungeonName = "Abyssal Void"
        if playerLevel < 215 then
            dungeonName = "Desert Temple"
        end

        local dungeonEvent = replicatedStorage:FindFirstChild("DungeonJoin")
        if dungeonEvent then
            dungeonEvent:FireServer(dungeonName, "Nightmare")
            print("Đã tự động vào " .. dungeonName .. " (Nightmare) qua nút!")
            wait(10) -- Chờ 10 giây trước khi thử lại
        else
            print("Không tìm thấy RemoteEvent để vào hầm ngục!")
            wait(5)
        end
    end
end

autoDungeonButton.MouseButton1Click:Connect(function()
    isAutoDungeonButtonOn = not isAutoDungeonButtonOn
    autoDungeonButton.Text = "Auto Dungeon: " .. (isAutoDungeonButtonOn and "ON" or "OFF")
    if isAutoDungeonButtonOn then
        spawn(autoDungeonButtonLogic)
        print("Đã bật Auto Dungeon (nút)!")
    else
        print("Đã tắt Auto Dungeon (nút)!")
    end
end)

-- 14. Autostats Logic
local function autostatsLogic()
    while autostatsMode ~= "None" do
        local statsEvent = replicatedStorage:FindFirstChild("UpgradeStat")
        if statsEvent then
            statsEvent:FireServer(autostatsMode)
            print("Đã nâng " .. autostatsMode .. "!")
        else
            print("Không tìm thấy RemoteEvent để nâng stats!")
        end
        wait(1)
    end
end

-- Kích hoạt Autostats khi chọn
physicalOption.MouseButton1Click:Connect(function()
    autostatsMode = "Physical"
    autostatsButton.Text = "Autostats: Physical"
    autostatsFrame.Visible = false
    print("Đã chọn Autostats: Physical")
    spawn(autostatsLogic)
end)

spellOption.MouseButton1Click:Connect(function()
    autostatsMode = "Spell"
    autostatsButton.Text = "Autostats: Spell"
    autostatsFrame.Visible = false
    print("Đã chọn Autostats: Spell")
    spawn(autostatsLogic)
end)

staminaOption.MouseButton1Click:Connect(function()
    autostatsMode = "Stamina"
    autostatsButton.Text = "Autostats: Stamina"
    autostatsFrame.Visible = false
    print("Đã chọn Autostats: Stamina")
    spawn(autostatsLogic)
end)

-- Thông báo khi script khởi động
print("Kinayo Script đã được khởi động thành công!")